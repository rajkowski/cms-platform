!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.supersetEmbeddedSdk=t():e.supersetEmbeddedSdk=t()}(globalThis,(()=>(()=>{"use strict";var __webpack_modules__={360:(module,__webpack_exports__,__webpack_require__)=>{var enterModule;__webpack_require__.d(__webpack_exports__,{J:()=>Switchboard}),module=__webpack_require__.hmd(module),enterModule="undefined"!=typeof reactHotLoaderGlobal?reactHotLoaderGlobal.enterModule:void 0,enterModule&&enterModule(module);var __signature__="undefined"!=typeof reactHotLoaderGlobal?reactHotLoaderGlobal.default.signature:function(e){return e},Actions=function(e){return e.GET="get",e.REPLY="reply",e.EMIT="emit",e.ERROR="error",e}(Actions||{});function isGet(e){return e.switchboardAction===Actions.GET}function isReply(e){return e.switchboardAction===Actions.REPLY}function isEmit(e){return e.switchboardAction===Actions.EMIT}function isError(e){return e.switchboardAction===Actions.ERROR}class Switchboard{constructor(e){this.port=void 0,this.name="",this.methods={},this.incrementor=1,this.debugMode=void 0,this.isInitialised=void 0,e&&this.init(e)}init(e){if(this.isInitialised)return void this.logError("already initialized");const{port:t,name:r="switchboard",debug:o=!1}=e;this.port=t,this.name=r,this.debugMode=o,t.addEventListener("message",(async e=>{this.log("message received",e);const t=e.data;if(isGet(t))this.port.postMessage(await this.getMethodResult(t));else if(isEmit(t)){const{method:e,args:r}=t,o=this.methods[e];o&&o(r)}})),this.isInitialised=!0}async getMethodResult({messageId:e,method:t,args:r}){const o=this.methods[t];if(null==o)return{switchboardAction:Actions.ERROR,messageId:e,error:`[${this.name}] Method "${t}" is not defined`};try{const t=await o(r);return{switchboardAction:Actions.REPLY,messageId:e,result:t}}catch(r){return this.logError(r),{switchboardAction:Actions.ERROR,messageId:e,error:`[${this.name}] Method "${t}" threw an error`}}}defineMethod(e,t){this.methods[e]=t}get(e,t=void 0){return new Promise(((r,o)=>{if(!this.isInitialised)return void o(new Error("Switchboard not initialised"));const s=this.getNewMessageId(),i=e=>{const t=e.data;if(t.messageId===s)if(this.port.removeEventListener("message",i),isReply(t))r(t.result);else{const e=isError(t)?t.error:"Unexpected response message";o(new Error(e))}};this.port.addEventListener("message",i),this.port.start();const a={switchboardAction:Actions.GET,method:e,messageId:s,args:t};this.port.postMessage(a)}))}emit(e,t=void 0){if(!this.isInitialised)return void this.logError("Switchboard not initialised");const r={switchboardAction:Actions.EMIT,method:e,args:t};this.port.postMessage(r)}start(){this.isInitialised?this.port.start():this.logError("Switchboard not initialised")}log(...e){this.debugMode&&console.debug(`[${this.name}]`,...e)}logError(...e){console.error(`[${this.name}]`,...e)}getNewMessageId(){return`m_${this.name}_${this.incrementor++}`}__reactstandin__regenerateByEval(key,code){this[key]=eval(code)}}const _default=new Switchboard;var __WEBPACK_DEFAULT_EXPORT__=_default,reactHotLoader,leaveModule;reactHotLoader="undefined"!=typeof reactHotLoaderGlobal?reactHotLoaderGlobal.default:void 0,reactHotLoader&&(reactHotLoader.register(isGet,"isGet","/Users/evan_1/GitHub/superset/superset-frontend/packages/superset-ui-switchboard/src/switchboard.ts"),reactHotLoader.register(isReply,"isReply","/Users/evan_1/GitHub/superset/superset-frontend/packages/superset-ui-switchboard/src/switchboard.ts"),reactHotLoader.register(isEmit,"isEmit","/Users/evan_1/GitHub/superset/superset-frontend/packages/superset-ui-switchboard/src/switchboard.ts"),reactHotLoader.register(isError,"isError","/Users/evan_1/GitHub/superset/superset-frontend/packages/superset-ui-switchboard/src/switchboard.ts"),reactHotLoader.register(Switchboard,"Switchboard","/Users/evan_1/GitHub/superset/superset-frontend/packages/superset-ui-switchboard/src/switchboard.ts"),reactHotLoader.register(_default,"default","/Users/evan_1/GitHub/superset/superset-frontend/packages/superset-ui-switchboard/src/switchboard.ts")),leaveModule="undefined"!=typeof reactHotLoaderGlobal?reactHotLoaderGlobal.leaveModule:void 0,leaveModule&&leaveModule(module)}},__webpack_module_cache__={};function __webpack_require__(e){var t=__webpack_module_cache__[e];if(void 0!==t)return t.exports;var r=__webpack_module_cache__[e]={id:e,loaded:!1,exports:{}};return __webpack_modules__[e](r,r.exports,__webpack_require__),r.loaded=!0,r.exports}__webpack_require__.d=(e,t)=>{for(var r in t)__webpack_require__.o(t,r)&&!__webpack_require__.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},__webpack_require__.hmd=e=>((e=Object.create(e)).children||(e.children=[]),Object.defineProperty(e,"exports",{enumerable:!0,set:()=>{throw new Error("ES Modules may not assign module.exports or exports.*, Use ESM export syntax, instead: "+e.id)}}),e),__webpack_require__.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),__webpack_require__.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var __webpack_exports__={};__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{embedDashboard:()=>embedDashboard});const IFRAME_COMMS_MESSAGE_TYPE="__embedded_comms__",DASHBOARD_UI_FILTER_CONFIG_URL_PARAM_KEY={visible:"show_filters",expanded:"expand_filters"};var switchboard=__webpack_require__(360);class InvalidTokenError extends Error{}function b64DecodeUnicode(e){return decodeURIComponent(atob(e).replace(/(.)/g,((e,t)=>{let r=t.charCodeAt(0).toString(16).toUpperCase();return r.length<2&&(r="0"+r),"%"+r})))}function base64UrlDecode(e){let t=e.replace(/-/g,"+").replace(/_/g,"/");switch(t.length%4){case 0:break;case 2:t+="==";break;case 3:t+="=";break;default:throw new Error("base64 string is not of the correct length")}try{return b64DecodeUnicode(t)}catch(e){return atob(t)}}function jwtDecode(e,t){if("string"!=typeof e)throw new InvalidTokenError("Invalid token specified: must be a string");t||(t={});const r=!0===t.header?0:1,o=e.split(".")[r];if("string"!=typeof o)throw new InvalidTokenError(`Invalid token specified: missing part #${r+1}`);let s;try{s=base64UrlDecode(o)}catch(e){throw new InvalidTokenError(`Invalid token specified: invalid base64 for part #${r+1} (${e.message})`)}try{return JSON.parse(s)}catch(e){throw new InvalidTokenError(`Invalid token specified: invalid json for part #${r+1} (${e.message})`)}}InvalidTokenError.prototype.name="InvalidTokenError";const REFRESH_TIMING_BUFFER_MS=5e3,MIN_REFRESH_WAIT_MS=1e4,DEFAULT_TOKEN_EXP_MS=3e5;function getGuestTokenRefreshTiming(e){const t=jwtDecode(e),r=new Date(/[^0-9\.]/g.test(t.exp)?t.exp:1e3*parseFloat(t.exp));return("Invalid Date"!==r.toString()?Math.max(MIN_REFRESH_WAIT_MS,r.getTime()-Date.now()):DEFAULT_TOKEN_EXP_MS)-REFRESH_TIMING_BUFFER_MS}async function embedDashboard({id:e,supersetDomain:t,mountPoint:r,fetchGuestToken:o,dashboardUiConfig:s,debug:i=!1,iframeTitle:a="Embedded Dashboard",iframeSandboxExtras:n=[]}){function d(...t){i&&console.debug(`[superset-embedded-sdk][dashboard ${e}]`,...t)}function c(){let e=0;return s&&(s.hideTitle&&(e+=1),s.hideTab&&(e+=2),s.hideChartControls&&(e+=8)),e}d("embedding"),t.endsWith("/")&&(t=t.slice(0,-1));const[_,l]=await Promise.all([o(),async function(){return new Promise((o=>{const _=document.createElement("iframe"),l=s?{uiConfig:`${c()}`}:void 0,u=s?.filters||{},p=Object.keys(u),h={...l,...Object.fromEntries(p.map((e=>[DASHBOARD_UI_FILTER_CONFIG_URL_PARAM_KEY[e],u[e]]))),...s?.urlParams},b=Object.keys(h).length?"?"+new URLSearchParams(h).toString():"";_.sandbox.add("allow-same-origin"),_.sandbox.add("allow-scripts"),_.sandbox.add("allow-presentation"),_.sandbox.add("allow-downloads"),_.sandbox.add("allow-forms"),_.sandbox.add("allow-popups"),n.forEach((e=>{_.sandbox.add(e)})),_.addEventListener("load",(()=>{const e=new MessageChannel,r=e.port1,s=e.port2;_.contentWindow.postMessage({type:IFRAME_COMMS_MESSAGE_TYPE,handshake:"port transfer"},t,[s]),d("sent message channel to the iframe"),o(new switchboard.J({port:r,name:"superset-embedded-sdk",debug:i}))})),_.src=`${t}/embedded/${e}${b}`,_.title=a,r.replaceChildren(_),d("placed the iframe")}))}()]);return l.emit("guestToken",{guestToken:_}),d("sent guest token"),setTimeout((async function e(){const t=await o();l.emit("guestToken",{guestToken:t}),setTimeout(e,getGuestTokenRefreshTiming(t))}),getGuestTokenRefreshTiming(_)),{getScrollSize:()=>l.get("getScrollSize"),unmount:function(){d("unmounting"),r.replaceChildren()},getDashboardPermalink:e=>l.get("getDashboardPermalink",{anchor:e}),getActiveTabs:()=>l.get("getActiveTabs")}}return __webpack_exports__})()));
//# sourceMappingURL=index.js.map